<div class="default-loader d-flex justify-content-center w-100 h-100" *ngIf="showLazyLoader">
    <div class="align-self-center text-center">
        <span class="fa fa-spinner fa-pulse fa-3x"></span>
        <div class="text-secondary mt-2">Processing...</div>
    </div>
</div>
<div class="d-flex flex-column position-relative">
    <odp-breadcrumb [paths]="breadcrumbPaths"></odp-breadcrumb>
    <div class="options d-flex justify-content-between align-items-center w-100 border-bottom px-3">
        <div class="font-weight-bold font-lg">List of Users</div>
        <odp-search-box (enteredText)="searchUser($event)" (reset)="resetUserSearch()"></odp-search-box>
        <div class="d-flex align-items-center">
            <div class="d-flex align-items-center mr-3">
                <span *ngIf="authType==='local'" class="fa fa-info-circle text-muted high-zIndex"
                    ngbTooltip="Authentication Mode: Local" container="body" placement="top"></span>
                <span *ngIf="authType==='ldap'" class="fa fa-info-circle text-muted high-zIndex"
                    ngbTooltip="Authentication Mode: LDAP" container="body" placement="top"></span>
                <span *ngIf="authType==='azure'" class="fa fa-info-circle text-muted high-zIndex"
                    ngbTooltip="Authentication Mode: Azure" container="body" placement="top"></span>
            </div>
            <ng-container *ngIf="!usersMarked && hasPermission('PMUBC')">
                <button type="button" *ngIf="authType==='local'" class="add-new btn-min-width btn btn-primary"
                    (click)="newUser()">
                    <span class="fa fa-plus mr-2"></span>
                    <span class="text">New User</span>
                </button>
                <button type="button" *ngIf="(authType==='azure' || authType==='ldap')"
                    class="add-new btn-min-width btn btn-primary" (click)="openImportUserModal()">
                    <span class="fa fa-plus mr-2"></span>
                    <span class="text">Import User</span>
                </button>
            </ng-container>
            <ng-container *ngIf="usersMarked && hasPermission('PMUBD'); else emptyDiv">
                <button type="button" class="btn-min-width btn btn-primary" (click)="removeSelectedUsers()">Remove
                    User(s)</button>
            </ng-container>
            <ng-template #emptyDiv>
                <div class="fill-empty-space"></div>
            </ng-template>
        </div>
    </div>
    <div class="d-flex flex-column w-100 mt-4 pb-3 px-3">
        <div class="user-list">
            <div class="data-grid-options d-flex align-items-center justify-content-between px-2">
                <div class="d-flex align-items-center">
                    <ng-container *ngIf="hasPermission('PMUBD') && totalRecords">
                        <odp-round-check [(checked)]="checkAllUser" [edit]="{status:true}"></odp-round-check>
                        <span class="text-accent ml-2 font-sm hover" (click)="checkAllUser=!checkAllUser">
                            Select All
                        </span>
                    </ng-container>
                </div>
                <div class="d-flex align-items-center" *ngIf="totalRecords">
                    <span class="page-info">
                        {{startNo}}-{{endNo}} of {{totalRecords}}
                    </span>
                    <button type="button" class="btn btn-link ml-2" [disabled]="disablePrev" (click)="prevPage()">
                        <span class="fa fa-angle-left"></span>
                    </button>
                    <button type="button" class="btn btn-link ml-2" [disabled]="disableNext" (click)="nextPage()">
                        <span class="fa fa-angle-right"></span>
                    </button>
                </div>
            </div>
            <div class="data-grid border" odpDataGrid [(columns)]="tableColumns"
                (sortModelChange)="sortModelChange($event)">
                <div class="data-grid-header">
                    <div class="data-grid-row">
                        <div id="_checkbox"
                            class="data-grid-cell head-cell d-flex align-items-center no-move no-grip no-sort">
                            <!-- <span class="fa fa-search text-accent open-search"></span> -->
                        </div>
                        <div id="basicDetails.name" class="data-grid-cell head-cell d-flex align-items-center no-move">
                            Name
                        </div>
                        <div id="username" class="data-grid-cell head-cell d-flex align-items-center no-move">
                            Username
                        </div>
                        <div id="basicDetails.phone" class="data-grid-cell head-cell d-flex align-items-center no-move">
                            Phone
                        </div>
                        <div id="_metadata.lastUpdated"
                            class="data-grid-cell head-cell d-flex align-items-center no-move">
                            Last Login</div>
                        <div id="_options"
                            class="data-grid-cell head-cell d-flex align-items-center no-move no-grip no-sort">
                        </div>
                    </div>
                </div>
                <div class="data-grid-body">
                    <div class="data-grid-row" *ngFor="let usr of userList;let usrIndex=index"
                        [ngClass]="{'selectedRow': usrIndex == selectedRow}">
                        <div class="data-grid-cell d-flex align-items-center">
                            <div class="d-flex align-items-center justify-content-center"
                                *ngIf="hasPermission('PMUBD')">
                                <odp-round-check [(checked)]="usr.checked" [edit]="{status:true}"></odp-round-check>
                            </div>
                        </div>
                        <div class="data-grid-cell d-flex align-items-center"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            <ng-container *ngIf="usr.basicDetails;else noName">
                                <ng-container *ngIf="usr.basicDetails.name && usr.basicDetails.name.trim();else noName">
                                    <div class="d-flex align-items-center">
                                        <span class="mr-1 high-zIndex" [ngbTooltip]="usr.basicDetails.name"
                                            *ngIf="usr.basicDetails.name.length > 50" placement="top">
                                            <span class="admin-placeholder">
                                                <sup *ngIf="isAppAdmin(usr)" class="fa fa-star text-warning high-zIndex"
                                                    ngbTooltip="App admin of the active app"></sup>
                                            </span>
                                            <span>{{usr.basicDetails.name}}</span>
                                        </span>
                                        <span *ngIf="usr.basicDetails.name.length <= 50">
                                            <span class="admin-placeholder">
                                                <sup *ngIf="isAppAdmin(usr)" class="fa fa-star text-warning high-zIndex"
                                                    ngbTooltip="App admin of the active app"></sup>
                                            </span>
                                            <span>{{usr.basicDetails.name}}</span>
                                        </span>
                                        <span *ngIf="isThisUser(usr)" class="text-accent mr-3 pl-1">(You)</span>
                                    </div>
                                </ng-container>
                            </ng-container>
                            <ng-template #noName>
                                <span class="text-muted">N.A.</span>
                            </ng-template>
                        </div>
                        <div class="data-grid-cell d-flex align-items-center" *ngIf="usr.username.length <= 40"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            {{usr.username}}
                        </div>
                        <div class="data-grid-cell d-flex align-items-center high-zIndex"
                            *ngIf="usr.username.length > 40" [ngbTooltip]="usr.username" placement="top"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            {{usr.username}}
                        </div>
                        <div class="data-grid-cell d-flex align-items-center"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            <span class="pr-4">{{ usr.basicDetails.phone ? usr.basicDetails.phone : '--' }}</span>
                        </div>
                        <div class="data-grid-cell d-flex align-items-center"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            <span *ngIf="usr.lastLogin"
                                class="text-secondary">{{ usr.lastLogin|date: 'dd-MMM-yyyy, hh:mm' }}</span>
                            <span *ngIf="!usr.lastLogin" class="text-secondary">N.A.</span>
                        </div>
                        <div class="data-grid-cell d-flex align-items-center"
                            (click)="editUser($event, usr._id, null, usrIndex)">
                            <div class="d-flex justify-content-center">
                                <span class="fas fa-angle-right text-muted"></span>
                            </div>
                        </div>
                    </div>
                    <div class="data-grid-row justify-content-center full-row" *ngIf="showLazyLoader">
                        <div class="data-grid-cell d-flex align-items-center" class="text-center">
                            <span class="fa fa-spinner fa-pulse fa-lg"></span>
                        </div>
                    </div>
                    <div class="data-grid-row justify-content-center full-row"
                        *ngIf="!showLazyLoader && userList.length === 0">
                        <div class="data-grid-cell d-flex align-items-center">
                            <div class="no-users font-normal text-secondary">No Users Found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex position-absolute user-manage" *ngIf="showUsrManage" [@slideIn]>
        <odp-user-manage [toggleUserMng]="showUsrManage" [bredcrumbSub]="bredcrumbSubject"
            (toggleUserMngChange)="showUsrManage = $event; breadcrumbPaths.pop();" [user]="selectedUser"
            (removeUser)="rmUsrFromApp($event)"></odp-user-manage>
    </div>
    <div *ngIf="toggleImportUsers" class="user-import bg-white w-100 h-100 position-absolute">
        <odp-auth-users [(toggle)]="toggleImportUsers" [authType]="authType"></odp-auth-users>
    </div>
</div>

<ng-template #newUserModal>
    <div class="modal-body px-4 py-3">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <span class="icon-wrapper create rounded-circle d-flex align-items-center justify-content-center mr-2">
                    <odp-user-icon [size]="18" color="1CAD49" class="mt-1"></odp-user-icon>
                </span>
                <span class="font-weight-bold">Create new User</span>
            </div>
            <span class="fa fa-times text-secondary hover" (click)="newUserModalRef.close(false)"></span>
        </div>
        <div class="d-flex align-items-center ml-2">
            <div class="basic-detail-icon mr-2">
                <span class="far fa-user fa-sm text-secondary"></span>
            </div>
            <span class="text font-weight-bold">Basic Details</span>
        </div>
        <form class="d-flex flex-column p-4" [formGroup]="userForm" (ngSubmit)="showCreateForm ? addUser() : import()"
            odpFocusNext (trigger)="showCreateForm ? addUser() : import()">
            <div formGroupName="userData">
                <div class="d-flex w-100 mb-3">
                    <div class="label-width text-secondary">Username</div>
                    <div class="value-width position-relative w-100">
                        <input class="form-control" type="text" placeholder="Enter Username" formControlName="username"
                            odpAutoFocus (blur)="checkForDuplicate()"
                            [ngClass]="{'is-invalid': invalidUsername || invalidUsernamePattern}">
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidUsername" ngbTooltip="This is a required field" placement="right"></span>
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidUsernamePattern" ngbTooltip="Username must be of email format"
                            placement="right"></span>
                    </div>
                </div>
                <div class="d-flex w-100 mb-3">
                    <div class="label-width text-secondary">Name</div>
                    <div class="value-width position-relative w-100" formGroupName="basicDetails">
                        <input class="form-control pr-4" type="text" placeholder="Enter Name" formControlName="name"
                            [ngClass]="{'is-invalid': invalidName}" autocomplete="autocomplete_off_hack">
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidName" ngbTooltip="This is a required field" placement="right"></span>
                    </div>
                </div>
                <div *ngIf="showCreateForm" class="d-flex w-100 mb-3 position-relative">
                    <div class="label-width text-secondary">Password</div>
                    <div class="value-width position-relative w-100">
                        <input class="form-control password-input" [type]="showPassword ? 'text' : 'password'"
                            placeholder="Password" formControlName="password"
                            [ngClass]="{'is-invalid': invalidPassword || invalidPasswordLength}"
                            autocomplete="new-password">
                        <span class="fas fa-question-circle text-danger error-icon-password position-absolute"
                            *ngIf="invalidPassword" ngbTooltip="This is a required field" placement="right"></span>
                        <span class="fas fa-question-circle text-danger error-icon-password  position-absolute"
                            *ngIf="invalidPasswordLength" ngbTooltip="Password should be minimum 8 chars long"
                            placement="right"></span>
                    </div>
                    <span class="fas eye-icon position-absolute hover"
                        [ngClass]="{'fa-eye': !showPassword,'fa-eye-slash': showPassword }"
                        (click)="showPassword= !showPassword"></span>
                </div>
                <div *ngIf="showCreateForm" class="d-flex w-100 mb-3">
                    <div class="label-width text-secondary">Confirm Password</div>
                    <div class="value-width position-relative w-100">
                        <input class="form-control" type="password" placeholder="Confirm Password"
                            formControlName="cpassword"
                            [ngClass]="{'is-invalid': invalidCPassword || invalidPasswordMatch}">
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidCPassword" ngbTooltip="This is a required field" placement="right"></span>
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidPasswordMatch" ngbTooltip="Passwords do not match" placement="right"></span>
                    </div>
                </div>
                <div *ngIf="showCreateForm" class="d-flex w-100 mb-3">
                    <div class="label-width text-secondary">Phone</div>
                    <div class="value-width position-relative w-100" formGroupName="basicDetails">
                        <input class="form-control" type="text" placeholder="Enter Phone Number"
                            formControlName="phone">
                    </div>
                </div>
                <div *ngIf="showCreateForm" class="d-flex w-100 mb-3">
                    <div class="label-width text-secondary">Alternate Email</div>
                    <div class="value-width position-relative w-100" formGroupName="basicDetails">
                        <input class="form-control" type="text" placeholder="Enter Alternate Email"
                            formControlName="alternateEmail">
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidEmailPattern" ngbTooltip="Invalid Alternate Email" placement="right"></span>
                    </div>
                </div>
            </div>
            <div *ngIf="hasPermission('PMUG') && teamsArray.length>0">
                <div class="d-flex w-100">
                    <div class="label-width text-secondary">Teams</div>
                    <div class="value-width position-relative w-100">
                        <div class="d-flex flex-column position-relative">
                            <div class="d-flex align-items-center hover user-option-class form-control ignore-outside"
                                [ngClass]="{'open':displayTeamList}" (click)="displayTeamList = !displayTeamList"
                                odpClickOutside (outside)="displayTeamList = false;" [ignore]="['.ignore-outside']">
                                <span class="pr-2 w-100 ignore-outside">
                                    {{ selectedTeamSize > 0 ? selectedTeamSize + ' team(s) selected'
                                    : '--Select--'}}
                                </span>
                                <span class="fas fa-angle-down text-accent ignore-outside"></span>
                            </div>
                            <div *ngIf="displayTeamList" [@moveUp]
                                class="teamList border mt-2 position-absolute w-100 ignore-outside"
                                [ngClass]="{'teamList-newHeight':showCreateForm}">
                                <ul class="p-0 mb-0 ignore-outside" formArrayName="teamData">
                                    <li *ngFor="let team of teamsArray; index as teamIndex"
                                        class="p-2 hover ignore-outside">
                                        <label class="ignore-outside team-checkbox hover font-normal">
                                            {{teamList[teamIndex].name}}
                                            <input type="checkbox" class="mr-2 ignore-outside"
                                                [formControlName]="teamIndex" (change)="checkTeamSize()">
                                            <span class="team-selected ignore-outside"></span>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <span class="fas fa-question-circle text-danger error-icon position-absolute"
                            *ngIf="invalidTeamSize" ngbTooltip="User should be part of at-least one team"
                            placement="right"></span>
                    </div>
                </div>
            </div>
            <div *ngIf="!userInLocal && authType!=='local'" class="mt-3 text-center">
                <p class="text-accent" *ngIf="!userInLocal && userInOutside">User does not exist in this Environment.
                </p>
                <p class="text-delete" *ngIf="!userInLocal && !userInOutside">User does not exist.</p>
                <p class="text-delete" *ngIf="!canAccessOutside">You don't have enough privileges to import users.</p>
            </div>
            <!-- <button type="submit" class="d-none">Submit</button> -->
        </form>
        <div class="d-flex align-items-center justify-content-end">
            <button *ngIf="!userInLocal && !userInOutside" type="button" class="btn btn-link text-dark"
                id="cancelNewUserYes" (click)="newUserModalRef.close(false)">Cancel</button>
            <button *ngIf="showCreateForm && hasPermission('PMUBC')" type="button" class="btn btn-create btn-min-width"
                id="createNewUserYes" (click)="addUser()">Create</button>
            <button *ngIf="userInLocal && !userInOutside && hasPermission('PMUBC')" type="button"
                class="btn btn-dark btn-min-width" id="importUser" (click)="importUser()">Import</button>
            <button *ngIf="!userInLocal && userInOutside && hasPermission('PMUBCE')" type="button"
                class="btn btn-dark btn-min-width" id="importUser" (click)="importUserFromOutside()">Import from
                {{authType=='azure'?'Azure':'LDAP'}}</button>
        </div>
    </div>
</ng-template>

<ng-template #reAuthenticateModal>
    <div class="modal-body p-4">
        <div class="d-flex align-items-center justify-content-center my-3">
            <div class="super-admin-icon"></div>
        </div>
        <div class="d-flex flex-column w-100 align-items-center justify-content-between">
            <p class="text-dark font-weight-bold text-center m-0 font-large">Please enter your password to continue</p>
            <p class="text-secondary text-center p-3 m-0">
                Logged in as:&nbsp;{{username}}
            </p>
            <input type="password" class="form-control text-center w-75 mb-3 border-dark"
                [(ngModel)]="reAuthenticatePassword" placeholder="Password" (keyup.enter)="reAuthnticate()">
            <p class="text-danger">{{errorMessage}}&nbsp;<span class="fa fa-spinner fa-pulse text-dark"
                    *ngIf="reAuthnticateLoader"></span></p>
            <div class="d-flex justify-content-between w-75 mb-3">
                <button type="button" class="btn btn-link" (click)="reAuthenticateModalRef.close(false)">Cancel</button>
                <button type="button" class="btn btn-primary btn-min-width"
                    (click)="reAuthnticate()">Authenticate</button>
            </div>
        </div>
    </div>
</ng-template>